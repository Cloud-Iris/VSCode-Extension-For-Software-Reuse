<!-- 此文件用于编辑插件侧边栏 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>需求分解</title>
    <!-- <link rel="stylesheet" href="###CSS"> -->
    <link rel="stylesheet" href="./css/style-requirement.css">
</head>
<body>
    <div class="input-container" id="input-container">
        <input type="text" id="requirement-input" placeholder="请输入需求">
        <button onclick="submitRequirement()">提交</button>
        <div id="error-message" class="error-message"></div>
    </div>
    <!-- 将用户的输入需求以 h1 展示在页面上 -->
    <div class="requirement" id="requirement-title"></div>
    <!-- 存放各级拆解后的子需求的大容器 -->
    <div class="sub-requirements" id="sub-requirements"></div>

    <script>
        function submitRequirement() {
            const input = document.getElementById('requirement-input').value;
            const errorMessage = document.getElementById('error-message');
            if (!input.trim()) {
                errorMessage.textContent = '请输入需求';
                return;
            }
            errorMessage.textContent = '';

            const requirementTitle = document.getElementById('requirement-title');
            const subRequirements = document.getElementById('sub-requirements');
            const inputContainer = document.getElementById('input-container');

            // 设置主需求标题
            requirementTitle.innerHTML = `<h1>${input}</h1>`;
            // 清空之前的各级子需求
            subRequirements.innerHTML = '';

            // 主容器 插入 二级需求列容器
            const _2LevelReqColumn = document.createElement('div');
            _2LevelReqColumn.className = 'mid-level-req-column';
            subRequirements.appendChild(_2LevelReqColumn);
            // 二级需求列容器 插入 二级需求容器
            const _2LevelReqContainer = document.createElement('div');
            _2LevelReqContainer.className = 'mid-level-requirements';
            _2LevelReqColumn.appendChild(_2LevelReqContainer);
            // 二级需求列容器 插入 增加二级需求的按钮
            addBtnForAddMidLevelReq(_2LevelReqColumn, _2LevelReqContainer, '二');

            // 二级需求容器 插入 三个默认的二级需求 TODO: 请在此处实现动态添加二级需求的逻辑
            for (let i = 1; i <= 3; i++) {
                addSubRequirement(_2LevelReqContainer, `二级需求 ${i}`);
            }

            // 主容器 插入 三级需求列容器
            const _3LevelReqColumn = document.createElement('div');
            _3LevelReqColumn.className = 'mid-level-req-column';
            subRequirements.appendChild(_3LevelReqColumn);
            // 三级需求列容器 插入 三级需求容器
            const _3LevelReqContainer = document.createElement('div');
            _3LevelReqContainer.className = 'mid-level-requirements';
            _3LevelReqColumn.appendChild(_3LevelReqContainer);
            // 三级需求列容器 插入 增加三级需求的按钮
            addBtnForAddMidLevelReq(_3LevelReqColumn, _3LevelReqContainer, '三');

            // 二级需求容器 插入 三个默认的三级需求 TODO: 请在此处实现动态添加三级需求的逻辑
            for (let i = 1; i <= 3; i++) {
                addSubRequirement(_3LevelReqContainer, `三级需求 ${i}`);
            }
            
            // 隐藏输入框和提交按钮
            inputContainer.style.display = 'none';
        }

        function addBtnForAddMidLevelReq(parentElement, targetElementForAddReq, level='二') {
            if (parentElement instanceof HTMLElement && targetElementForAddReq instanceof HTMLElement) {
                const addMidLevelReqBtn = document.createElement('button');
                addMidLevelReqBtn.textContent = `新增${level}级需求`;
                addMidLevelReqBtn.className = 'add-mid-level-req-btn';
                addMidLevelReqBtn.onclick = () => {
                    addSubRequirement(targetElementForAddReq, `${level}级需求`);
                };
                parentElement.appendChild(addMidLevelReqBtn);
            } else {
                console.error('parentElement is not a HTMLElement!!!');
                console.error('targetElementForAddReq is not a HTMLElement!!!');
            }
        }

        function addSubRequirement(parentElement, title = '二级需求') {
            if (parentElement instanceof HTMLElement) {
                const subRequirement = document.createElement('div');
                subRequirement.className = 'sub-requirement';
                subRequirement.innerHTML = `
                    <h2>${title}</h2>
                    <div class="content">
                        <div class="description" contenteditable="false">默认二级需求</div>
                        <div class="buttons">
                            <button onclick="editSubRequirement(this)">编辑</button>
                            <button onclick="decomposeSubRequirement(this)">分解</button>
                            <button onclick="deleteSubRequirement(this)">删除</button>
                        </div>
                    </div>
                `;
                parentElement.appendChild(subRequirement);
            } else {
                console.error('parentElement is not a HTMLElement!!!');
            }
        }

        function editSubRequirement(button) {
            const description = button.parentElement.previousElementSibling;
            if (button.textContent === '编辑') {
                button.textContent = '确定';
                description.contentEditable = 'true';
                description.focus();
            } else {
                button.textContent = '编辑';
                description.contentEditable = 'false';
            }
        }

        // function updateSubRequirement(description) {
        //     const button = description.nextElementSibling.querySelector('button');
        //     if (button.textContent === '确定') {
        //         button.textContent = '编辑';
        //         description.contentEditable = 'false';
        //     }
        // }

        function decomposeSubRequirement(button) {
            // 实现分解二级需求的逻辑
            alert('分解二级需求功能待实现');
        }

        function deleteSubRequirement(button) {
            const subRequirement = button.parentElement.parentElement.parentElement;
            subRequirement.remove();
        }
    </script>
</body>
</html>